<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Sistem Reservasi ‚Äî Demo Pro (Stabil)</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #2a9d8f;
      --primary-dark: #264653;
      --danger: #e76f51;
      --info: #0077b6;
      --warning: #e9c46a;
      --bg: #f8f9fa;
      --dark: #343a40;
      --light: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.6;
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: var(--light);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h2 { font-weight: 600; font-size: 1.4rem; margin-bottom: 4px; }
    header small { opacity: 0.85; font-size: 0.8rem; letter-spacing: 0.5px; }

    /* LAYOUT UTAMA */
    .container {
      max-width: 1000px;
      margin: 20px auto;
      background: var(--light);
      padding: 25px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: none; /* Hidden by default until login */
      animation: fadeIn 0.4s ease;
    }

    /* LOGIN */
    #login-container {
      max-width: 400px;
      margin: 80px auto;
      background: var(--light);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      display: none;
    }

    /* FORM ELEMENTS */
    label { display: block; margin-top: 15px; font-weight: 500; text-align: left; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-top: 6px;
      font-family: inherit;
      transition: border 0.3s;
    }
    input:focus, select:focus { border-color: var(--primary); }
    
    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      transition: opacity 0.2s, transform 0.1s;
    }
    button:active { transform: scale(0.98); }
    button.secondary { background: #6c757d; }
    button.danger { background: var(--danger); }
    button.info { background: var(--info); }
    button.sm { width: auto; padding: 8px 16px; margin-top: 0; font-size: 0.9rem; }
    
    /* CALENDAR GRID */
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .month-title { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .cal-head {
      text-align: center; font-weight: 600; color: #888; padding-bottom: 8px;
    }
    .cal-day {
      background: #f1f3f5;
      border-radius: 8px;
      min-height: 80px;
      padding: 8px;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .cal-day:hover { background: #e9ecef; }
    .cal-day.today { background: #e3f2fd; border-color: var(--info); }
    .cal-day.selected { border-color: var(--primary); background: #e6fffa; }
    .cal-day.empty { background: transparent; cursor: default; }
    
    .day-num { font-weight: 600; font-size: 1.1rem; }
    .badge {
      position: absolute; bottom: 8px; right: 8px;
      background: var(--danger); color: white;
      font-size: 0.75rem; padding: 2px 8px;
      border-radius: 12px; font-weight: 600;
    }

    /* RESERVATION LIST */
    .res-card {
      background: #fff;
      border: 1px solid #eee;
      border-left: 5px solid var(--primary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .res-info h4 { margin-bottom: 4px; color: var(--dark); }
    .res-meta { color: #666; font-size: 0.9rem; }
    .res-actions { display: flex; gap: 8px; }

    /* MODAL / POPUP */
    #modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 2000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }
    .modal-box {
      background: #fff; width: 90%; max-width: 480px;
      padding: 25px; border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease;
    }

    /* UTILITY */
    .text-center { text-align: center; }
    .flex-gap { display: flex; gap: 10px; }
    .hidden { display: none !important; }
    #logout-btn {
      position: absolute; top: 20px; right: 20px;
      background: rgba(255,255,255,0.2); width: auto;
      padding: 6px 14px; margin: 0; font-size: 0.85rem;
      border: 1px solid rgba(255,255,255,0.4);
    }
    #logout-btn:hover { background: rgba(255,255,255,0.3); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>

<body>

<header>
  <h2>Sistem Reservasi</h2>
  <small>Demo Pro ‚Ä¢ Stabil & Aman ‚Ä¢ LocalStorage</small>
  <button id="logout-btn" class="hidden" onclick="App.logout()">Keluar</button>
</header>

<div id="login-container">
  <h3>Login Admin</h3>
  <p style="color:#666; margin-bottom:20px; font-size:0.9rem">Email: admin@demo.com | Pass: bebas</p>
  
  <form onsubmit="App.login(event)">
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-pass" placeholder="Password" required>
    <button type="submit">Masuk Dashboard</button>
  </form>
  <p id="login-msg" style="color:var(--danger); margin-top:10px; display:none;">Login Gagal</p>
</div>

<div class="container" id="main-dashboard">
  <div id="view-calendar">
    <div class="calendar-header">
      <div class="month-title" id="cal-month-year">...</div>
      <div class="flex-gap">
        <button class="secondary sm" onclick="Calendar.prevMonth()">&#10094;</button>
        <button class="secondary sm" onclick="Calendar.goToday()">Hari Ini</button>
        <button class="secondary sm" onclick="Calendar.nextMonth()">&#10095;</button>
      </div>
    </div>
    
    <div class="calendar-grid">
      <div class="cal-head">Min</div><div class="cal-head">Sen</div>
      <div class="cal-head">Sel</div><div class="cal-head">Rab</div>
      <div class="cal-head">Kam</div><div class="cal-head">Jum</div>
      <div class="cal-head">Sab</div>
    </div>
    <div class="calendar-grid" id="cal-body"></div>
  </div>

  <div id="view-detail" class="hidden">
    <div class="calendar-header">
      <h3 id="detail-date-title">Reservasi</h3>
      <div class="flex-gap">
        <button class="secondary sm" onclick="UI.showCalendar()">Kembali</button>
        <button class="sm" onclick="FormModal.open()">+ Tambah</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:20px;">
      <input type="text" id="search-input" placeholder="Cari nama tamu..." onkeyup="DetailView.render()">
      <button class="info sm" style="width:auto" onclick="DetailView.print()">Cetak</button>
    </div>

    <div id="reservation-list"></div>
  </div>
</div>

<div id="modal-overlay">
  <div class="modal-box">
    <h3 id="modal-title" style="margin-bottom:15px">Tambah Reservasi</h3>
    <form id="reservation-form" onsubmit="FormModal.save(event)">
      <input type="hidden" id="f-id">
      
      <label>Nama Tamu</label>
      <input type="text" id="f-nama" placeholder="Contoh: Budi Santoso" required>
      
      <label>No. WhatsApp</label>
      <input type="tel" id="f-hp" placeholder="08xxxxxxxxxx">
      
      <div class="flex-gap">
        <div style="flex:1">
          <label>Jam</label>
          <input type="time" id="f-jam" required>
        </div>
        <div style="flex:1">
          <label>Jumlah Org</label>
          <input type="number" id="f-jumlah" min="1" value="2" required>
        </div>
      </div>

      <label>Pilih Tempat</label>
      <select id="f-tempat" required>
        </select>
      <small id="kapasitas-hint" style="color:#e76f51"></small>

      <div class="flex-gap" style="margin-top:20px">
        <button type="submit">Simpan</button>
        <button type="button" class="danger" onclick="FormModal.close()">Batal</button>
      </div>
    </form>
  </div>
</div>

<script>
/**
 * KONFIGURASI & UTILITAS
 */
const CONFIG = {
  DB_KEY: 'reservasi_pro_db_v2',
  AUTH_KEY: 'reservasi_pro_auth',
  LOCATIONS: [
    { id: 'pendopo', name: 'Pendopo Utama', cap: 50 },
    { id: 'saung1', name: 'Saung Sawah', cap: 10 },
    { id: 'vip', name: 'Ruang VIP', cap: 20 }
  ]
};

const Utils = {
  uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
  
  // Mencegah XSS (Cross Site Scripting)
  escapeHtml: (str) => {
    if(!str) return '';
    return str.replace(/[&<>"']/g, function(m) {
      return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
    });
  },

  // Format Tanggal YYYY-MM-DD
  formatDateKey: (dateObj) => {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  },

  // Format Tampilan Tanggal Indonesia
  formatDateIndo: (dateStr) => {
    const d = new Date(dateStr);
    const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }
};

/**
 * DATABASE ENGINE (LocalStorage)
 */
const DB = {
  data: { reservations: {} },

  init() {
    const stored = localStorage.getItem(CONFIG.DB_KEY);
    if (stored) {
      try {
        this.data = JSON.parse(stored);
        // Pastikan struktur objek ada
        if (!this.data.reservations) this.data.reservations = {};
      } catch (e) {
        console.error("DB Corrupt, resetting...", e);
        this.save();
      }
    } else {
      // Seed data awal jika kosong
      this.seed(); 
    }
  },

  save() {
    localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(this.data));
  },

  seed() {
    const today = Utils.formatDateKey(new Date());
    this.data.reservations[today] = [{
      id: Utils.uuid(),
      nama: 'Tamu Demo',
      hp: '08123456789',
      jam: '12:00',
      jumlah: 4,
      tempat: 'Pendopo Utama'
    }];
    this.save();
  },

  get(dateKey) {
    return this.data.reservations[dateKey] || [];
  },

  add(dateKey, item) {
    if (!this.data.reservations[dateKey]) this.data.reservations[dateKey] = [];
    this.data.reservations[dateKey].push(item);
    this.save();
  },

  update(dateKey, id, newItem) {
    const list = this.get(dateKey);
    const idx = list.findIndex(x => x.id === id);
    if (idx !== -1) {
      list[idx] = newItem;
      this.save();
    }
  },

  delete(dateKey, id) {
    const list = this.get(dateKey);
    const idx = list.findIndex(x => x.id === id);
    if (idx !== -1) {
      list.splice(idx, 1);
      // Bersihkan key jika array kosong untuk hemat memori
      if (list.length === 0) delete this.data.reservations[dateKey];
      this.save();
    }
  }
};

/**
 * LOGIKA APLIKASI
 */
const App = {
  isLoggedIn: false,

  init() {
    DB.init();
    this.checkAuth();
    
    // Setup Dropdown Tempat di Form
    const select = document.getElementById('f-tempat');
    select.innerHTML = '';
    CONFIG.LOCATIONS.forEach(loc => {
      const opt = document.createElement('option');
      opt.value = loc.name;
      opt.text = `${loc.name} (Max ${loc.cap})`;
      opt.dataset.cap = loc.cap; // Simpan kapasitas di atribut data
      select.appendChild(opt);
    });

    // Event Listener Kapasitas
    select.addEventListener('change', function() {
      const cap = this.options[this.selectedIndex].dataset.cap;
      document.getElementById('kapasitas-hint').innerText = `Maksimal ${cap} orang`;
    });
  },

  checkAuth() {
    const session = localStorage.getItem(CONFIG.AUTH_KEY);
    if (session) {
      this.isLoggedIn = true;
      UI.showDashboard();
    } else {
      this.isLoggedIn = false;
      UI.showLogin();
    }
  },

  login(e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;

    if (email && pass) {
      localStorage.setItem(CONFIG.AUTH_KEY, 'active');
      this.checkAuth();
    } else {
      document.getElementById('login-msg').style.display = 'block';
    }
  },

  logout() {
    if(confirm('Keluar dari sistem?')) {
      localStorage.removeItem(CONFIG.AUTH_KEY);
      location.reload();
    }
  }
};

/**
 * MANAJEMEN KALENDER
 */
const Calendar = {
  currentDate: new Date(),
  selectedDateKey: null,

  render() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth(); // 0-11
    
    const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const calBody = document.getElementById('cal-body');
    calBody.innerHTML = '';

    // Slot kosong sebelum tanggal 1
    for (let i = 0; i < firstDay; i++) {
      calBody.insertAdjacentHTML('beforeend', `<div class="cal-day empty"></div>`);
    }

    // Render hari
    const todayKey = Utils.formatDateKey(new Date());

    for (let d = 1; d <= daysInMonth; d++) {
      const dateObj = new Date(year, month, d);
      const dateKey = Utils.formatDateKey(dateObj);
      const count = DB.get(dateKey).length;
      
      let classes = 'cal-day';
      if (dateKey === todayKey) classes += ' today';
      
      const badgeHTML = count > 0 ? `<div class="badge">${count}</div>` : '';

      const el = document.createElement('div');
      el.className = classes;
      el.innerHTML = `<div class="day-num">${d}</div>${badgeHTML}`;
      el.onclick = () => this.selectDate(dateKey);
      
      calBody.appendChild(el);
    }
  },

  prevMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
    this.render();
  },
  nextMonth() {
    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
    this.render();
  },
  goToday() {
    this.currentDate = new Date();
    this.render();
  },

  selectDate(dateKey) {
    this.selectedDateKey = dateKey;
    DetailView.init(dateKey);
    UI.showDetail();
  }
};

/**
 * MANAJEMEN VIEW DETAIL (List Reservasi)
 */
const DetailView = {
  currentKey: null,

  init(dateKey) {
    this.currentKey = dateKey;
    document.getElementById('detail-date-title').innerText = `Reservasi: ${Utils.formatDateIndo(dateKey)}`;
    document.getElementById('search-input').value = ''; // Reset search
    this.render();
  },

  render() {
    const list = DB.get(this.currentKey);
    const container = document.getElementById('reservation-list');
    const search = document.getElementById('search-input').value.toLowerCase();

    container.innerHTML = '';

    // Filter & Sort
    const filtered = list.filter(item => 
      item.nama.toLowerCase().includes(search)
    ).sort((a, b) => a.jam.localeCompare(b.jam));

    if (filtered.length === 0) {
      container.innerHTML = `<p class="text-center" style="color:#999; margin-top:30px">Belum ada reservasi.</p>`;
      return;
    }

    filtered.forEach(item => {
      // Sanitasi Output
      const safeName = Utils.escapeHtml(item.nama);
      const safePlace = Utils.escapeHtml(item.tempat);
      
      const html = `
        <div class="res-card">
          <div class="res-info">
            <h4>${safeName} <small>(${item.jumlah} Orang)</small></h4>
            <div class="res-meta">
              ‚è∞ ${item.jam} &bull; üìç ${safePlace} &bull; üìû ${item.hp || '-'}
            </div>
          </div>
          <div class="res-actions">
            <button class="info sm" onclick="FormModal.edit('${item.id}')">Edit</button>
            <button class="danger sm" onclick="DetailView.remove('${item.id}')">Hapus</button>
            ${item.hp ? `<button class="secondary sm" onclick="DetailView.wa('${item.hp}', '${safeName}')">WA</button>` : ''}
          </div>
        </div>
      `;
      container.innerHTML += html;
    });
  },

  remove(id) {
    if (confirm('Yakin ingin menghapus data ini?')) {
      DB.delete(this.currentKey, id);
      this.render();
      Calendar.render(); // Update badge di kalender
    }
  },

  wa(hp, nama) {
    let num = hp.replace(/\D/g, ''); // Hapus karakter non-angka
    if (num.startsWith('0')) num = '62' + num.substring(1);
    const text = `Halo Kak ${nama}, kami dari konfirmasi reservasi...`;
    window.open(`https://wa.me/${num}?text=${encodeURIComponent(text)}`, '_blank');
  },

  print() {
    window.print();
  }
};

/**
 * MANAJEMEN MODAL FORM (Add/Edit)
 */
const FormModal = {
  isEdit: false,

  open() {
    document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('modal-title').innerText = 'Tambah Reservasi';
    document.getElementById('reservation-form').reset();
    document.getElementById('f-id').value = '';
    this.isEdit = false;
    
    // Trigger change untuk reset hint kapasitas
    document.getElementById('f-tempat').dispatchEvent(new Event('change'));
  },

  edit(id) {
    const list = DB.get(DetailView.currentKey);
    const item = list.find(x => x.id === id);
    if (!item) return;

    this.open();
    this.isEdit = true;
    document.getElementById('modal-title').innerText = 'Edit Reservasi';
    
    document.getElementById('f-id').value = item.id;
    document.getElementById('f-nama').value = item.nama;
    document.getElementById('f-hp').value = item.hp;
    document.getElementById('f-jam').value = item.jam;
    document.getElementById('f-jumlah').value = item.jumlah;
    document.getElementById('f-tempat').value = item.tempat;
  },

  close() {
    document.getElementById('modal-overlay').style.display = 'none';
  },

  save(e) {
    e.preventDefault();
    
    // Ambil Values
    const id = document.getElementById('f-id').value || Utils.uuid();
    const nama = document.getElementById('f-nama').value.trim();
    const hp = document.getElementById('f-hp').value.trim();
    const jam = document.getElementById('f-jam').value;
    const jumlah = parseInt(document.getElementById('f-jumlah').value);
    const tempat = document.getElementById('f-tempat').value;

    // Validasi Tambahan
    if (jumlah < 1) { alert('Jumlah orang minimal 1'); return; }

    const data = { id, nama, hp, jam, jumlah, tempat };

    if (this.isEdit) {
      DB.update(DetailView.currentKey, id, data);
    } else {
      DB.add(DetailView.currentKey, data);
    }

    this.close();
    DetailView.render();
    Calendar.render(); // Update badge
  }
};

/**
 * KONTROL UI GLOBAL
 */
const UI = {
  showLogin() {
    document.getElementById('login-container').style.display = 'block';
    document.getElementById('main-dashboard').style.display = 'none';
    document.getElementById('logout-btn').classList.add('hidden');
  },
  showDashboard() {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('main-dashboard').style.display = 'block';
    document.getElementById('logout-btn').classList.remove('hidden');
    Calendar.render();
    this.showCalendar(); // Reset ke view kalender
  },
  showCalendar() {
    document.getElementById('view-calendar').classList.remove('hidden');
    document.getElementById('view-detail').classList.add('hidden');
  },
  showDetail() {
    document.getElementById('view-calendar').classList.add('hidden');
    document.getElementById('view-detail').classList.remove('hidden');
  }
};

// Start App saat DOM siap
document.addEventListener('DOMContentLoaded', () => {
  App.init();
});

</script>
</body>
</html>
