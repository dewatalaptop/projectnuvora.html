<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReservaHub Pro v3.0 | Ultimate Reservation System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-100: #f1f5f9;
            --bg-light: #f8fafc;
            --sidebar-width: 260px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-light); color: var(--slate-900); overflow-x: hidden; }

        /* UI Elements */
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--secondary); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        
        .form-control { width: 100%; padding: 0.7rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; outline: none; transition: 0.2s; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--secondary); }

        /* Layout */
        #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top left, #4f46e5, #1e293b); }
        .login-card { background: white; padding: 2.5rem; border-radius: 1.5rem; width: 100%; max-width: 420px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        
        .demo-badge { position: absolute; top: -10px; right: 20px; background: var(--warning); color: black; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; box-shadow: var(--shadow); }

        #app-container { display: none; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--slate-800); color: white; position: fixed; height: 100vh; z-index: 100; transition: 0.3s; }
        .nav-item { padding: 0.9rem 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #94a3b8; border-left: 4px solid transparent; }
        .nav-item.active { background: rgba(79, 70, 229, 0.1); color: white; border-left-color: var(--primary); }

        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; box-shadow: var(--shadow); z-index: 90; }

        /* Calendar UX */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #e2e8f0; }
        .calendar-day { min-height: 120px; padding: 0.5rem; border: 0.5px solid #e2e8f0; cursor: pointer; background: white; transition: 0.2s; }
        .calendar-day:hover { background: var(--slate-100); }
        .res-pill { background: var(--primary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .more-indicator { font-size: 0.65rem; color: var(--secondary); font-weight: 600; padding-left: 5px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 2rem; border-radius: 1.2rem; width: 95%; max-width: 750px; max-height: 90vh; overflow-y: auto; }

        /* Utilities */
        .card { background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--slate-900); }
        .badge { padding: 0.3rem 0.6rem; border-radius: 2rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .bg-confirmed { background: #dcfce7; color: #166534; }
        .bg-cancelled { background: #fee2e2; color: #991b1b; }
        .bg-completed { background: #e0e7ff; color: #3730a3; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--slate-800); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-top: 10px; box-shadow: var(--shadow); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-page">
        <div class="login-card">
            <div class="demo-badge">ðŸ”’ Demo Mode - Simplified Auth</div>
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 style="letter-spacing: -1px;">Reserva<span style="color: var(--primary);">Hub</span> <small style="font-size: 0.5em; vertical-align: middle;">PRO v3</small></h1>
                <p style="color: var(--secondary); font-size: 0.85rem;">Login: admin@demo.local / admin123</p>
            </div>
            <form id="login-form">
                <div style="margin-bottom: 1rem;">
                    <label>Email Address</label>
                    <input type="email" id="login-email" class="form-control" value="admin@demo.local" required>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label>Password</label>
                    <input type="password" id="login-pass" class="form-control" value="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">Masuk ke Sistem</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div style="padding: 2rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                <h2 style="font-size: 1.2rem;">RH <span style="color: var(--primary);">PRO SYSTEM</span></h2>
            </div>
            <ul class="nav-menu" style="list-style: none; padding-top: 1rem;">
                <li class="nav-item active" data-page="dashboard"><i class="fas fa-chart-pie"></i> Dashboard</li>
                <li class="nav-item" data-page="calendar"><i class="fas fa-calendar-alt"></i> Kalender</li>
                <li class="nav-item" data-page="reservations"><i class="fas fa-list-ul"></i> Reservasi</li>
                <li class="nav-item" data-page="analytics"><i class="fas fa-brain"></i> Business Insight</li>
                <li class="nav-item" data-page="settings"><i class="fas fa-cog"></i> Pengaturan</li>
            </ul>
            <div style="position: absolute; bottom: 0; width: 100%; padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
                <button onclick="Auth.logout()" class="btn btn-ghost" style="color: var(--danger); width: 100%;"><i class="fas fa-power-off"></i> Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <header>
                <h3 id="page-title">Dashboard</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="notif-bell" style="position: relative; cursor: pointer;">
                        <i class="fas fa-bell fa-lg" style="color: var(--secondary);"></i>
                        <span id="notif-count" class="badge" style="position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; display: none;">0</span>
                    </div>
                    <img src="https://ui-avatars.com/api/?name=Admin&background=4f46e5&color=fff" style="width: 35px; border-radius: 50%;">
                </div>
            </header>

            <div id="main-render" style="padding: 2rem;"></div>
        </main>
    </div>

    <div id="modal-res" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 id="modal-title">Form Reservasi</h3>
                <button onclick="UI.closeModal()" class="btn btn-ghost" style="font-size: 1.5rem;">&times;</button>
            </div>
            <form id="res-form">
                <input type="hidden" id="res-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div><label>Nama Pelanggan</label><input type="text" id="res-name" class="form-control" required></div>
                    <div><label>WhatsApp</label><input type="tel" id="res-phone" class="form-control" placeholder="08..." required></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div><label>Tanggal</label><input type="date" id="res-date" class="form-control" required></div>
                    <div><label>Jam</label><input type="time" id="res-time" class="form-control" required></div>
                    <div><label>Pax</label><input type="number" id="res-pax" class="form-control" min="1" required></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div><label>Lokasi</label><select id="res-location" class="form-control" required></select></div>
                    <div><label>Status</label>
                        <select id="res-status" class="form-control">
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div style="background: var(--slate-100); padding: 1rem; border-radius: 0.8rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="margin: 0;">Pesanan Menu</label>
                        <button type="button" onclick="Reservations.addMenuRow()" class="btn btn-primary btn-sm">+ Tambah</button>
                    </div>
                    <div id="menu-list"></div>
                    <div style="text-align: right; margin-top: 10px; font-weight: 700;">Total: <span id="total-bill-label">Rp 0</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div><label>DP Amount</label><input type="number" id="res-dp" class="form-control" value="0"></div>
                    <div><label>Metode</label><select id="res-method" class="form-control"><option>Transfer</option><option>Cash</option></select></div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="UI.closeModal()" class="btn btn-ghost">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        /** 1. DATA & DB MODULE **/
        const DB = (() => {
            const defaults = {
                reservations: [],
                customers: [],
                locations: [
                    { id: 1, name: 'Main Hall', capacity: 50 },
                    { id: 2, name: 'VIP AC Room', capacity: 15 },
                    { id: 3, name: 'Garden Area', capacity: 30 }
                ],
                menus: [
                    { id: 1, name: 'Paket Buffet A', price: 125000 },
                    { id: 2, name: 'Coffee Break Premium', price: 55000 },
                    { id: 3, name: 'Ala Carte Steak', price: 85000 }
                ]
            };

            return {
                init: () => {
                    console.warn("DEMO MODE: Data initialized in LocalStorage");
                    Object.entries(defaults).forEach(([k, v]) => {
                        if (!localStorage.getItem(k)) localStorage.setItem(k, JSON.stringify(v));
                    });
                },
                get: (key) => JSON.parse(localStorage.getItem(key)) || [],
                set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
            };
        })();

        /** 2. UTILS MODULE **/
        const Utils = (() => {
            return {
                formatIDR: (v) => "Rp " + new Number(v).toLocaleString('id-ID'),
                toast: (m) => {
                    const t = document.createElement('div');
                    t.className = 'toast'; t.innerText = m;
                    document.getElementById('toast-container').appendChild(t);
                    setTimeout(() => t.remove(), 3000);
                },
                normalizePhone: (p) => {
                    let c = p.replace(/\D/g, '');
                    return c.startsWith('0') ? '62' + c.slice(1) : c;
                },
                timeDiff: (t1, t2) => {
                    const [h1, m1] = t1.split(':').map(Number);
                    const [h2, m2] = t2.split(':').map(Number);
                    return Math.abs((h1 + m1/60) - (h2 + m2/60));
                }
            };
        })();

        /** 3. AUTH MODULE **/
        const Auth = (() => {
            return {
                check: () => sessionStorage.getItem('rh_session') === 'active',
                login: (e, p) => {
                    if (e === 'admin@demo.local' && p === 'admin123') {
                        sessionStorage.setItem('rh_session', 'active');
                        location.reload();
                    } else Utils.toast("Kredensial salah!");
                },
                logout: () => { sessionStorage.clear(); location.reload(); }
            };
        })();

        /** 4. RESERVATIONS LOGIC **/
        const Reservations = (() => {
            return {
                addMenuRow: (name = '', qty = 1) => {
                    const list = document.getElementById('menu-list');
                    const menus = DB.get('menus');
                    const row = document.createElement('div');
                    row.style = "display:grid; grid-template-columns: 1fr 80px 40px; gap:8px; margin-bottom:8px;";
                    row.innerHTML = `
                        <select class="form-control m-name" onchange="Reservations.calcTotal()">
                            ${menus.map(m => `<option value="${m.name}" data-p="${m.price}" ${m.name===name?'selected':''}>${m.name} (@${m.price/1000}k)</option>`).join('')}
                        </select>
                        <input type="number" class="form-control m-qty" value="${qty}" min="1" onchange="Reservations.calcTotal()">
                        <button type="button" class="btn btn-ghost" onclick="this.parentElement.remove(); Reservations.calcTotal();" style="color:var(--danger)">&times;</button>
                    `;
                    list.appendChild(row);
                    Reservations.calcTotal();
                },
                calcTotal: () => {
                    let total = 0;
                    document.querySelectorAll('#menu-list > div').forEach(row => {
                        const sel = row.querySelector('.m-name');
                        total += parseInt(sel.selectedOptions[0].dataset.p) * parseInt(row.querySelector('.m-qty').value);
                    });
                    document.getElementById('total-bill-label').innerText = Utils.formatIDR(total);
                    return total;
                },
                save: (e) => {
                    e.preventDefault();
                    const total = Reservations.calcTotal();
                    const dp = parseInt(document.getElementById('res-dp').value);
                    if (dp > total) return Utils.toast("DP tidak boleh melebihi total tagihan!");

                    const id = document.getElementById('res-id').value || Date.now().toString();
                    const date = document.getElementById('res-date').value;
                    const time = document.getElementById('res-time').value;
                    const loc = document.getElementById('res-location').value;
                    const pax = parseInt(document.getElementById('res-pax').value);

                    // ADVANCED CAPACITY CHECK (Time Window Â±2h)
                    const resAll = DB.get('reservations');
                    const locCap = DB.get('locations').find(l => l.name === loc).capacity;
                    const currentOccupancy = resAll
                        .filter(r => r.id !== id && r.date === date && r.location === loc && r.status !== 'cancelled' && Utils.timeDiff(r.time, time) < 2)
                        .reduce((s, r) => s + parseInt(r.pax), 0);

                    if (currentOccupancy + pax > locCap) {
                        return alert(`Kapasitas penuh! Pada jam tersebut sudah terisi ${currentOccupancy} pax dari total ${locCap}.`);
                    }

                    const menus = [...document.querySelectorAll('#menu-list > div')].map(row => ({
                        name: row.querySelector('.m-name').value,
                        price: parseInt(row.querySelector('.m-name').selectedOptions[0].dataset.p),
                        qty: parseInt(row.querySelector('.m-qty').value)
                    }));

                    const payload = {
                        id, date, time, pax, location: loc, status: document.getElementById('res-status').value,
                        customerName: document.getElementById('res-name').value,
                        phone: Utils.normalizePhone(document.getElementById('res-phone').value),
                        menus, totalBill: total, dpAmount: dp, method: document.getElementById('res-method').value,
                        updatedAt: new Date().toISOString()
                    };

                    const idx = resAll.findIndex(r => r.id === id);
                    if (idx > -1) resAll[idx] = payload; else resAll.push(payload);

                    DB.set('reservations', resAll);
                    UI.closeModal();
                    UI.renderPage(document.querySelector('.nav-item.active').dataset.page);
                    Utils.toast("Data berhasil disimpan!");
                }
            };
        })();

        /** 5. UI & ROUTER **/
        const UI = (() => {
            const renderArea = document.getElementById('main-render');
            const pageTitle = document.getElementById('page-title');

            return {
                init: () => {
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.onclick = () => {
                            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            UI.renderPage(item.dataset.page);
                        };
                    });
                    UI.renderPage('dashboard');
                },
                renderPage: (page) => {
                    pageTitle.innerText = page.toUpperCase();
                    const data = DB.get('reservations');

                    if (page === 'dashboard') {
                        const totalRev = data.filter(r=>r.status!=='cancelled').reduce((s,r)=>s+r.totalBill, 0);
                        const totalPax = data.filter(r=>r.status!=='cancelled').reduce((s,r)=>s+parseInt(r.pax), 0);
                        renderArea.innerHTML = `
                            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.5rem; margin-bottom:2rem;">
                                <div class="card"><label>Total Est. Revenue</label><div class="stat-val">${Utils.formatIDR(totalRev)}</div></div>
                                <div class="card"><label>Total Tamu</label><div class="stat-val">${totalPax} <small style="font-size:12px">Pax</small></div></div>
                                <div class="card"><label>Booking Aktif</label><div class="stat-val">${data.filter(r=>r.status==='confirmed').length}</div></div>
                            </div>
                            <div class="card"><h3>Tren Reservasi</h3><canvas id="chart-rev" height="80"></canvas></div>
                        `;
                        UI.initChart();
                    } 
                    else if (page === 'calendar') {
                        UI.renderCalendar();
                    }
                    else if (page === 'reservations') {
                        renderArea.innerHTML = `
                            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                                <input type="text" placeholder="Cari nama/HP..." class="form-control" style="max-width:300px;">
                                <button onclick="UI.openModal()" class="btn btn-primary">+ Booking Baru</button>
                            </div>
                            <div class="card" style="padding:0; overflow:hidden;">
                                <table style="width:100%; border-collapse:collapse;">
                                    <thead style="background:var(--slate-100);">
                                        <tr><th style="padding:1rem; text-align:left;">Pelanggan</th><th>Jadwal</th><th>Area</th><th>Total</th><th>Status</th><th>Aksi</th></tr>
                                    </thead>
                                    <tbody>
                                        ${data.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r => `
                                            <tr style="border-bottom:1px solid #eee;">
                                                <td style="padding:1rem;"><strong>${r.customerName}</strong><br><small>${r.phone}</small></td>
                                                <td>${r.date}<br>${r.time}</td>
                                                <td>${r.location}</td>
                                                <td>${Utils.formatIDR(r.totalBill)}</td>
                                                <td><span class="badge bg-${r.status}">${r.status}</span></td>
                                                <td>
                                                    <button onclick="UI.editRes('${r.id}')" class="btn btn-ghost" style="color:var(--primary)"><i class="fas fa-edit"></i></button>
                                                    <button onclick="UI.sendWA('${r.id}')" class="btn btn-ghost" style="color:#25d366"><i class="fab fa-whatsapp"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    else if (page === 'analytics') {
                        UI.renderAnalytics();
                    }
                },
                renderCalendar: () => {
                    const now = new Date();
                    const month = now.getMonth(), year = now.getFullYear();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDay = new Date(year, month, 1).getDay();
                    const resAll = DB.get('reservations');

                    let html = `<div class="card calendar-grid">`;
                    ['Min','Sen','Sel','Rab','Kam','Jum','Sab'].forEach(d => html += `<div style="text-align:center; padding:10px; font-weight:700; background:var(--slate-100); font-size:0.75rem;">${d}</div>`);
                    for(let i=0; i<firstDay; i++) html += `<div class="calendar-day" style="background:#fafafa"></div>`;
                    
                    for(let d=1; d<=daysInMonth; d++) {
                        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                        const dayBookings = resAll.filter(r => r.date === dateStr && r.status !== 'cancelled');
                        html += `
                            <div class="calendar-day" onclick="UI.openModal('${dateStr}')">
                                <div style="font-weight:700; margin-bottom:5px;">${d}</div>
                                ${dayBookings.slice(0, 2).map(b => `<div class="res-pill">${b.customerName.split(' ')[0]}</div>`).join('')}
                                ${dayBookings.length > 2 ? `<div class="more-indicator">+${dayBookings.length-2} more</div>` : ''}
                            </div>
                        `;
                    }
                    renderArea.innerHTML = `<h3>${now.toLocaleString('id-ID', {month:'long', year:'numeric'})}</h3>` + html + `</div>`;
                },
                renderAnalytics: () => {
                    const res = DB.get('reservations').filter(r => r.status !== 'cancelled');
                    if (res.length === 0) return renderArea.innerHTML = `<div class="card">Belum ada data untuk dianalisis.</div>`;

                    // Logic: Repeat Customers
                    const freq = {}; res.forEach(r => freq[r.phone] = (freq[r.phone] || 0) + 1);
                    const repeats = Object.values(freq).filter(f => f > 1).length;

                    // Logic: Peak Hours
                    const hours = {}; res.forEach(r => { const h = r.time.split(':')[0]; hours[h] = (hours[h] || 0) + 1; });
                    const peakHour = Object.keys(hours).reduce((a, b) => hours[a] > hours[b] ? a : b) + ":00";

                    renderArea.innerHTML = `
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
                            <div class="card">
                                <h3>Customer Loyalty</h3>
                                <div class="stat-val" style="color:var(--success)">${repeats} Pelanggan</div>
                                <p style="font-size:0.8rem; color:var(--secondary)">Pelanggan yang melakukan pemesanan lebih dari 1x.</p>
                            </div>
                            <div class="card">
                                <h3>Jam Sibuk (Peak Hour)</h3>
                                <div class="stat-val" style="color:var(--primary)">Pukul ${peakHour}</div>
                                <p style="font-size:0.8rem; color:var(--secondary)">Waktu dengan frekuensi kedatangan tamu tertinggi.</p>
                            </div>
                        </div>
                        <div class="card" style="border-left: 5px solid var(--primary);">
                            <h3>ðŸ’¡ AI Business Insight</h3>
                            <p style="margin-top:10px; line-height:1.6;">
                                Strategi optimal untuk bulan ini: Tingkatkan promosi paket menu pada jam <strong>${peakHour}</strong>. 
                                Anda memiliki <strong>${repeats}</strong> pelanggan setia, pertimbangkan untuk memberikan diskon khusus <em>Loyalty Member</em> 
                                untuk meningkatkan retensi sebesar 15-20%.
                            </p>
                        </div>
                    `;
                },
                initChart: () => {
                    const ctx = document.getElementById('chart-rev').getContext('2d');
                    const res = DB.get('reservations').filter(r => r.status !== 'cancelled').slice(-10);
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: res.map(r => r.date),
                            datasets: [{ label: 'Revenue Trend', data: res.map(r => r.totalBill), borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.05)' }]
                        },
                        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                    });
                },
                openModal: (date = '', resObj = null) => {
                    document.getElementById('res-form').reset();
                    document.getElementById('res-id').value = '';
                    document.getElementById('menu-list').innerHTML = '';
                    document.getElementById('modal-title').innerText = resObj ? "Edit Reservasi" : "Booking Baru";
                    
                    const locSel = document.getElementById('res-location');
                    locSel.innerHTML = DB.get('locations').map(l => `<option value="${l.name}">${l.name} (Cap: ${l.capacity})</option>`).join('');

                    if (resObj) {
                        document.getElementById('res-id').value = resObj.id;
                        document.getElementById('res-name').value = resObj.customerName;
                        document.getElementById('res-phone').value = resObj.phone;
                        document.getElementById('res-date').value = resObj.date;
                        document.getElementById('res-time').value = resObj.time;
                        document.getElementById('res-pax').value = resObj.pax;
                        document.getElementById('res-location').value = resObj.location;
                        document.getElementById('res-status').value = resObj.status;
                        document.getElementById('res-dp').value = resObj.dpAmount;
                        resObj.menus.forEach(m => Reservations.addMenuRow(m.name, m.qty));
                    } else {
                        document.getElementById('res-date').value = date || new Date().toISOString().split('T')[0];
                        Reservations.addMenuRow();
                    }
                    document.getElementById('modal-res').style.display = 'flex';
                },
                closeModal: () => document.getElementById('modal-res').style.display = 'none',
                editRes: (id) => {
                    const r = DB.get('reservations').find(x => x.id === id);
                    UI.openModal('', r);
                },
                sendWA: (id) => {
                    const r = DB.get('reservations').find(x => x.id === id);
                    const msg = `Halo ${r.customerName}, konfirmasi reservasi di ${r.location} tgl ${r.date} jam ${r.time}. Total: ${Utils.formatIDR(r.totalBill)}.`;
                    window.open(`https://wa.me/${r.phone}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            };
        })();

        /** 6. INIT APP **/
        DB.init();
        if (!Auth.check()) {
            document.getElementById('login-page').style.display = 'flex';
        } else {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            UI.init();
        }

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            Auth.login(document.getElementById('login-email').value, document.getElementById('login-pass').value);
        };
        document.getElementById('res-form').onsubmit = Reservations.save;

    </script>
</body>
</html>
